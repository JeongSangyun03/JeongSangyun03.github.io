---
layout : post
title : 인과추론
categories : 쿠다3주차
---
# 인과추론
**연관관계는 인과관계인가?** : 될 수도 있고, 안될 수도 있다. 

-> 우연에 따른 상관관계일 수도 있으나, 혼동하기 쉬움

|연관관계|인과관계|
|-----|-----|
|두 개의 수치나 확률변수가 같이 움직이는 것|한 변수의 변화가 다른 변수의 변화를 일으키는 것|

: 인과추론은 연관관계로부터 인과관계를 추론하고 언제, 그리고 왜 서로 다른지 이해하는 것

**머신러닝과 인과추론** 

머신러닝은 예측 문제를 다룰 때 유용. (변수 간의 연관관계를 이용해서 변수들을 다른 변수에서 예측) -> 단순 예측 적용 시 의미 없는 결론을 내릴 수도 있음 or 과적합 가능성 다분 

: 인과추론과 머신러닝을 함께 사용해야 함

**연관관계와 인과관계**

동일한 원인이 유형에 따라 다른 영향을 미칠 수도 있음 (ex : 온라인 커머스 사이트에서 식품, 의류, 비료, 농산물 등의 다양한 상품에 가격 인하라는 처치를 내렸을 때 다른 영향을 미칠 수 있음 [기간에 따른, 이벤트에 따른])

인과추론에서의 **분석단위** : 개입(처치)하려는 대상

개입(처치) : 변화를 유발하는 원인이 되는 요소. 구하려는 효과에 대한 개입을 나타낼 때 사용하는 용어 (T or D)

인과추론의 목표는 T가 결과값 $$\ Y_i\ $$ 에 대해 미치는 영향을 학습하는 과정

**인과추론의 근본적인 문제**

: 일어나지 않은 일을 알 수 없다. (**반사실 상황**)

```
A기업이 가격 인하를 했을 때(A=treated)와 안 했을 때(A=control)를 동시에 볼 수 없다는 것.

실제로는 한 시점에서 A기업은 하나의 선택(인하 or 비인하)만 했으니, 나머지는 가정된 반사실적 결과일 뿐.
→ 따라서 관측 가능한 데이터만으로는 “가격 인하가 매출 변화에 미친 순수한 인과효과”를 알기 어려움.
```
---

**인과모델**

**인과모델(causal model)** 은 화살표(→)로 표시되는 입력의 합당 메커니즘.

- $$\( u \)$$: 모델 외부의 변수(외부변수, exogenous variable)  
- 변수 $$\( u \)$$가 어떻게 생성되었는지는 따로 설명하지 않는다.  
- $$\( u \)$$ 이외의 다른 변수들은 모두 중요하므로 모델에 포함된다.  
- 각 변수는 함수 $$\( f \)$$를 통해 다른 변수에 매핑된다.  

**구조적 인과모델 수식**

$$\[
T \leftarrow f_T(u_T)
\]
$$
$$
\[
Y \leftarrow f_Y(T, u_Y)
\]
$$

**해석**

1. 첫 번째 식: 모델링하지 않은 변수 집합 $$\( u_T \)$$ (외부변수)가 함수 $$\( f_T \)$$를 통해 **처치 변수 $$\( T \)$$** 를 유발한다.  
2. 두 번째 식: 결과 변수 $$\( Y \)$$는 **처치 변수 $$\( T \)$$** 와 외부변수 $$\( u_Y \)$$를 함께 함수 $$\( f_Y \)$$에 넣어 결정된다.  
3. 즉, 결과 $$\( Y \)$$는 단순히 처치 $$\( T \)$$에 의해서만 결정되는 것이 아니라, 모델링하지 않은 외부 요인 $$\( u_Y \)$$에도 영향을 받는다.

**모델링하지 않은 변수 집합?** 

: 머신러닝 VS 인과모델

1. 머신러닝/통계 모델

모든 독립변수들을 직접 입력 변수로 사용한다.  

$$
Y = f(X_1, X_2, \dots, X_p) + \epsilon
$$

- $$X_1, X_2, \dots, X_p$$ : 독립변수(설명변수) 집합  
- $$Y$$ : 결과변수  
- $$\epsilon$$ : 설명되지 않는 잡음  

목표는 **예측 정확도**.  

---

2. 인과모델 (SCM: Structural Causal Model)

변수들을 두 가지로 구분한다.  

1. **내생변수(Endogenous)**: 모델 안에서 방정식으로 정의되는 변수  
2. **외생변수(Exogenous)**: 모델 밖에서 주어지며, 여러 요인을 묶어서 표현하는 변수  

예시: 가격 인하와 판매량  

$$
Price \leftarrow f_{Price}(u_{Price})
$$

$$
Sales \leftarrow f_{Sales}(Price, u_{Sales})
$$

- $$Price$$ : 내생변수 (처치 변수)  
- $$Sales$$ : 내생변수 (결과 변수)  
- $$u_{Price}$$ : 원가, 경쟁사 전략, 경영진 의사결정 등 (모델링하지 않은 외부 요인)  
- $$u_{Sales}$$ : 소비심리, 경기 상황 등 (모델링하지 않은 외부 요인)  

목표는 **변수들이 생성되는 구조와 인과관계**를 표현.  

---

- 머신러닝에서는: **모든 $$X$$ 들을 직접 독립변수로 투입**  
- 인과모델에서는: **여러 $$X$$ 들을 묶어서 외생변수 $$u$$ 로 처리**, 구조적 관계를 간결하게 표현

※ 화살표를 사용하는 이유 : 인과관계의 비가역성 (주변으로 간단하게 변수를 옮길 수 없다.)

## 1. 외생변수 (Exogenous variable, $$u$$)

- **정의**: 시스템 밖에서 주어지고, 모델 안에 포함되지 않은 요인들  
- **특징**:  
  - 다른 변수들에 영향을 줄 수 있음  
  - 하지만 모델에 직접 명시하지 않고 $$u$$로 묶어 표현  
- **예시**: 기업 규모(BusinessSize)에 영향을 주는 요인들  
  - 시장 위치  
  - 설립연도  
  - 자본력  
→ 전부 묶어서 외생변수 $$u$$ 로 둠  

---

## 2. 내생변수 (Endogenous variable)

- **정의**: 시스템 안에서 다른 변수와 외생변수에 의해 결정되는 변수  
- **예시**:  
  - $$IsOnSales$$ (할인 여부)  
  - $$AmountSold$$ (판매량)  
  - $$BusinessSize$$ (기업 규모) → 외생변수 영향을 받아 결정되므로 내생변수로 모델에 포함 가능  

---

## 3. BusinessSize 변수를 추가하는 이유

- **기존 모델**  

$$
IsOnSales \leftarrow f_1(u_1)
$$

$$
AmountSold \leftarrow f_2(IsOnSales, u_2)
$$

- **문제점**: 기업 규모 차이가 할인 전략과 판매량 모두에 영향을 줄 수 있음 → 교란 가능성  
- **해결**: BusinessSize를 내생변수로 추가하여  
  - “기업 규모 때문에 발생하는 차이”를 더 명확히 반영  

**새로운 인과모델 수식**

$$
BusinessSize \leftarrow f_1(u_1)
$$

$$
IsOnSales \leftarrow f_2(BusinessSize, u_2)
$$

$$
AmountSold \leftarrow f_3(IsOnSales, BusinessSize, u_3)
$$

- $$u_1, u_2, u_3$$ : 외생변수들 (모델에 포함되지 않은 요인들)  
- $$BusinessSize$$ : 내생변수 (기업 규모)  
- $$IsOnSales$$ : 내생변수 (할인 여부), BusinessSize와 외생변수의 영향을 받음  
- $$AmountSold$$ : 내생변수 (판매량), 할인 여부와 기업 규모, 외생변수들의 영향을 받음  

---

**개입** 

우리가 인과 시스템에 인위적으로 변화를 가했을 때 결과를 보는 경우. $P(Y \mid do(X=x))$라고 씀.

<img width="500" height="249" alt="image" src="https://github.com/user-attachments/assets/868dd4b7-beb6-453b-ab6f-0736df78cb7e" />

**잠재적 결과** (=반사실적 효과)

잠재적 결과와 인과효과 정의 (수식)

- 개별 처치 효과 (Individual Treatment Effect, ITE):
$$
ITE_i = Y_i(1) - Y_i(0)
$$

인과추론 기본 가정: 일치성과 SUTVA

1. 일치성 가정 (Consistency)
- 정의: 실제 받은 처치가 \(T=t\)이면, 관찰된 결과 \(Y\)는 잠재적 결과 \(Y(t)\)와 동일하다.
  \[
  T = t \implies Y = Y(t)
  \]
- 문제(위배 상황):
  - 처치가 잘못 정의된 경우 (예: 쿠폰 여러 장인데 단순히 "받았다/안 받았다"로 처리)
  - 서로 다른 형태의 처치를 하나로 뭉뚱그린 경우

2. SUTVA (Stable Unit Treatment Value Assumption)
- 정의: 
  1. **일치성(Consistency)** 포함
  2. **무간섭(No interference)** — 개인 \(i\)의 결과는 다른 개인 \(j\)의 처치에 영향을 받지 않는다.
- 문제(위배 상황):
  - 파급효과(Spillover effect) 발생 시
    - 예: 백신 접종 → 주변 사람의 접종 여부도 내 감염 확률에 영향
    - 예: 교육 프로그램 → 친구의 참여 여부가 내 성적에 영향

**인과추정량**

- 평균 처치 효과 (Average Treatment Effect, ATE):
$$
ATE = \mathbb{E}[Y(1) - Y(0)]
$$

처치 T가 평균적으로 미치는 영향 (개별 대상에 미치는 영향은 확인 불가)

데이터에서 ATE를 추정하고 싶을 땐 기댓값을 표본평균으로 대체할 것 

- 처치받은 집단에 대한 평균 효과 (ATT):
$$
ATT = \mathbb{E}[Y(1) - Y(0) \mid X=1]
$$

- 조건부 평균 처치 효과 (Conditional ATE, CATE):
$$
CATE(z) = \mathbb{E}[Y(1) - Y(0) \mid Z=z]
$$

변수 Z로 정의된 그룹에서의 처치 효과 => 개인화에 유용함

**편향** : 인과관계랑 연관관계를 다르게 만드는 요소

1. 우리가 원하는 것
- 잠재적 결과 기반 정의:
# 편향 추정량 (Biased Estimator) 정리

1. 우리가 원하는 것
- 잠재적 결과 기반 정의:
$$
\mathbb{E}[Y(0)], \quad \mathbb{E}[Y(1)]
$$

- ATE:
$$
ATE = \mathbb{E}[Y(1)] - \mathbb{E}[Y(0)]
$$



2. 실제로 추정할 때 쓰는 값
- 관찰 가능한 값:
$$
\mathbb{E}[Y \mid T=0], \quad \mathbb{E}[Y \mid T=1]
$$

- 즉, 실제로는
$$
\mathbb{E}[Y(0)] \approx \mathbb{E}[Y \mid T=0], \quad 
\mathbb{E}[Y(1)] \approx \mathbb{E}[Y \mid T=1]
$$

3. 문제
- 두 값이 **일치하지 않으면** (즉, $$\((Y(0), Y(1)) \$$not$$\perp T\$$)):
$$
\mathbb{E}[Y \mid T=t] \neq \mathbb{E}[Y(t)]
$$

- 이 경우,
$$
\mathbb{E}[Y \mid T=t] \text{ 는 } \mathbb{E}[Y(t)] \text{의 편향 추정량 (biased estimator)}
$$

<img width="500" height="361" alt="image" src="https://github.com/user-attachments/assets/13b6b065-4f6c-46ee-8b61-055b9adcbd86" />

편향의 시각적 이해 : 가격할인을 한 회사가 그렇지 않은 회사보다 우측에 더 집중되었으므로, 균형이 맞지 않는다. 

어떻게 해결할 것인가? : 식별 (관측 가능한 데이터에서 인과 추정량을 찾아내는 방법)

<img width="800" height="266" alt="image" src="https://github.com/user-attachments/assets/5b0ca8aa-7f4c-431a-8f48-78be335a06f9" />

### 그래프 인과모델


