---
layout : post
title : ì¿ ë‹¤MLê¸°ì´ˆ 3ì£¼ì°¨
categories : ì¿ ë‹¤ML ê¸°ì´ˆ
---
# RNNê³¼ CNNì„ ì‚¬ìš©í•œ ì‹œí€€ìŠ¤ ì²˜ë¦¬
## 15.1 ìˆœí™˜ ë‰´ëŸ°ê³¼ ìˆœí™˜ ì¸µ
ìˆœí™˜ ì‹ ê²½ë§ (RNN) : ì…ë ¥ ì¸µì—ì„œ ì¶œë ¥ ì¸µ ë°©í–¥ìœ¼ë¡œ íë¥´ê±°ë‚˜, ë’¤ìª½ìœ¼ë¡œ ìˆœí™˜í•˜ëŠ” ì—°ê²°ë„ ê°€ëŠ¥í•œ ì‹ ê²½ë§

![image](https://github.com/user-attachments/assets/6776e2e7-5f71-45b3-af93-81bb60224c57)

1. ê° ìˆœí™˜ ë‰´ëŸ°ì€ ì…ë ¥ì„ ìœ„í•œ ê°€ì¤‘ì¹˜ì™€ ì´ì „ íƒ€ì„ ìŠ¤í…ì˜ ì¶œë ¥ì„ ìœ„í•œ ê°€ì¤‘ì¹˜ë¥¼ ê°€ì§ 
2. ê° íƒ€ì„ ìŠ¤í…ë§ˆë‹¤ X(t)ì™€ ì´ì „ íƒ€ì„ ìŠ¤í…ì˜ ì¶œë ¥ì¸ y(t-1)ì„ ì…ë ¥ ë°›ìŒ (ì²« ë²ˆì§¸ íƒ€ì„ìŠ¤í…ì€ 0ìœ¼ë¡œ ì„¤ì •)

![image](https://github.com/user-attachments/assets/7b9dc5fe-8ae1-4718-b654-1345b6b1db75)

### 15.1.1 ë©”ëª¨ë¦¬ ì…€

*ë©”ëª¨ë¦¬ ì…€ì˜ ê°œë…*

â†’ ìˆœí™˜ ì‹ ê²½ë§(RNN)ì˜ ê¸°ë³¸ ìš”ì†Œë¡œ, ì¼ì •í•œ ë©”ëª¨ë¦¬ í˜•íƒœë¥¼ ê°€ì§€ê³  ìˆìŒ.

â†’ ì´ì „ íƒ€ì„ìŠ¤í…ì˜ ëª¨ë“  ì…ë ¥ì— ëŒ€í•œ í•¨ìˆ˜ë¡œ í‘œí˜„ë  ìˆ˜ ìˆìŒ.

â†’ í•˜ë‚˜ì˜ ìˆœí™˜ ë‰´ëŸ° ë˜ëŠ” ìˆœí™˜ ë‰´ëŸ° ì¸µ(ìŠ¤íƒ) ìœ¼ë¡œ êµ¬ì„±ë¨.

*ë©”ëª¨ë¦¬ ì…€ì˜ ì—­í• *

â†’ ë‹¨ê¸° íŒ¨í„´ í•™ìŠµ:

ë³´í†µ 10 ìŠ¤í… ì •ë„ì˜ ê¸¸ì´ì— ëŒ€í•œ íŒ¨í„´ì„ í•™ìŠµ ê°€ëŠ¥.

ë¬¸ì œì˜ íŠ¹ì„±ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì ìš©ë  ìˆ˜ ìˆìŒ.

ì¥ê¸° íŒ¨í„´ í•™ìŠµ:

10 ìŠ¤í… ì´ìƒì˜ ê¸´ íŒ¨í„´ë„ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ë”ìš± ê°•ë ¥í•œ ì…€ êµ¬ì¡°ê°€ í•„ìš”í•¨.

*ì…€ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸*

ì¼ë°˜ì ìœ¼ë¡œ ì…€ì˜ ìƒíƒœ â„(ğ‘¡)ëŠ” í˜„ì¬ íƒ€ì„ìŠ¤í…ì˜ ì…ë ¥ê³¼ ì´ì „ íƒ€ì„ìŠ¤í…ì˜ ìƒíƒœë¥¼ ë°˜ì˜í•˜ì—¬ ê²°ì •ë¨.

ìˆ˜ì‹ìœ¼ë¡œ í‘œí˜„í•˜ë©´:

![image](https://github.com/user-attachments/assets/6bedf92a-0386-4bdc-878a-0d7d0c9febfd)

### 15.1.2 ì…ë ¥ê³¼ ì¶œë ¥ ì‹œí€€ìŠ¤
RNNì€ ì…ë ¥ ì‹œí€€ìŠ¤ë¥¼ ë°›ì•„ì„œ ì¶œë ¥ ì‹œí€€ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ëª¨ë¸ (ì…ë ¥ê³¼ ì¶œë ¥ì˜ ê´€ê³„ì— ë”°ë¼ ë‹¤ì–‘í•œ êµ¬ì¡°ì˜ ë„¤íŠ¸ì›Œí¬ê°€ ì¡´ì¬)

|ë„¤íŠ¸ì›Œí¬ ìœ í˜•|ì„¤ëª…|ì˜ˆì‹œ|
|---|---|---|
|ì‹œí€€ìŠ¤-íˆ¬-ì‹œí€€ìŠ¤|ì…ë ¥ê³¼ ì¶œë ¥ì´ ëª¨ë‘ ì‹œí€€ìŠ¤|ì „ë ¥ ì†Œë¹„ëŸ‰ ì˜ˆì¸¡|
|ì‹œí€€ìŠ¤-íˆ¬-ë²¡í„°|ì…ë ¥ì€ ì‹œí€€ìŠ¤, ì¶œë ¥ì€ ê³ ì • ë²¡í„°|ê°ì • ë¶„ì„ (ê¸/ë¶€ì •)|
|ë²¡í„°-íˆ¬-ì‹œí€€ìŠ¤|ì…ë ¥ì€ ë²¡í„°, ì¶œë ¥ì€ ì‹œí€€ìŠ¤|ì´ë¯¸ì§€ â†’ ë¬¸ì¥ ì„¤ëª…|
|ì¸ì½”ë”-ë””ì½”ë”|ì…ë ¥ì„ ì¸ì½”ë”© í›„ ë””ì½”ë”©í•˜ì—¬ ë³€í™˜|ê¸°ê³„ ë²ˆì—­|

![image](https://github.com/user-attachments/assets/f4b619a7-a9b2-4d4b-885b-ea368897c7ab)

â€» ì¸ì½”ë”-ë””ì½”ë” ì´ì¤‘ ë‹¨ê³„ ëª¨ë¸ì—ì„œ ë””ì½”ë”ì˜ ì´ˆê¸° ì…ë ¥ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •í•´ë„, ë¬´ì—‡ì„ ì¶œë ¥í•´ì•¼ í• ì§€ íŒíŠ¸ê°€ í•„ìš”í•˜ë¯€ë¡œ, ì¸ì½”ë”ì˜ ë§ˆì§€ë§‰ ì€ë‹‰ ìƒíƒœ h(T) ë¥¼ ë””ì½”ë”ì˜ ì´ˆê¸° ì€ë‹‰ ìƒíƒœë¡œ ì‚¬ìš©

## 15.2 RNN í›ˆë ¨í•˜ê¸°
BPTT : RNNì„ í›ˆë ¨í•˜ê¸° ìœ„í•œ ê¸°ë²•ìœ¼ë¡œ, íƒ€ì„ ìŠ¤í…ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ í¼ì¹˜ê³  ë³´í†µì˜ ì—­ì „íŒŒë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ë²•

![image](https://github.com/user-attachments/assets/2ae10abe-52d8-4c10-be86-a80f3f1e2597)

â†’ ë„¤íŠ¸ì›Œí¬ê°€ ì‹œê°„ì— ë”°ë¼ í¼ì³ì§„ í˜•íƒœë¡œ ì¡´ì¬

1. ìˆœì „íŒŒ (Forward Pass)
â†’ ì…ë ¥ Xë¥¼ ê° íƒ€ì„ìŠ¤í…ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ì€ë‹‰ ìƒíƒœë¥¼ ì—…í…Œì´íŠ¸
â†’ ë§ˆì§€ë§‰ íƒ€ì„ìŠ¤í…ê¹Œì§€ ë„ë‹¬í•˜ë©´ ì˜ˆì¸¡ Yê°€ ìƒì„±ë¨
2. ì†ì‹¤í•¨ìˆ˜ ğ¿ ê³„ì‚°
â†’ ì¶œë ¥ Yì™€ ì‹¤ì œ ê°’ Y ë¹„êµí•˜ì—¬ ì†ì‹¤ ê³„ì‚° (ê·¸ë¦¼ì—ì„œëŠ” L(Y2,Y3,Y4) ì†ì‹¤ ê³„ì‚°ë¨)
3. ì—­ì „íŒŒ (Backward Pass)
â†’ ê³„ì‚°ëœ ì†ì‹¤ì„ ì‹œê°„ì„ ê±°ìŠ¬ëŸ¬ì„œ ê° íƒ€ì„ìŠ¤í…ì˜ ê°€ì¤‘ì¹˜ì— ëŒ€í•´ ë¯¸ë¶„ & ëª¨ë“  ê°€ì¤‘ì¹˜ Wì™€ b (ì´í•˜ íŒŒë¼ë¯¸í„°)ë¥¼ ì—…ë°ì´íŠ¸

â€» ì¼€ë¼ìŠ¤ê°€ ì‹¹ ë‹¤ ì²˜ë¦¬í•´ì¤Œ

## 15.3 ì‹œê³„ì—´ ì˜ˆì¸¡í•˜ê¸°
ì‹œê³„ì—´ ë°ì´í„° ë¡œë“œ ë° ì •ì œ
```python
import pandas as pd
from pathlib import Path

path = Path ('datasets/ridership/CTA_-_Ridership_-_Daily_Boarding_Totals.csv')
df = pd.read_csv (path, parse_dates["service_date"])
df.columns = ['date', 'day_type','bus','rail','total'] # ì§§ì€ ì´ë¦„
df = df.drop('total', axis = 1) # totalì€ ë‹¨ìˆœíˆ bus+railì´ë¯€ë¡œ ì œê±°
df = df.drop_duplicates () #ì¤‘ë³µ ì›” ì‚­ì œ (2011-10ê³¼ 2014-07)
```
ë‹¨ìˆœ ì˜ˆì¸¡ ë° ê²°ê³¼ ì‹œê°í™”

ë‹¨ìˆœ ì—ì¸¡ : ê³¼ê±° ì •ë³´(ê°€ì¥ ìµœê·¼ê°’)ë¥¼ ì´ìš©í•˜ì—¬ ë¯¸ë˜ ê°’ì„ ì§ì ‘ ì˜ˆì¸¡í•˜ëŠ” ë°©ë²• (íŒ¨í„´ì´ ë§¤ìš° ê°•ë ¥í•  ë•Œ)

```python
diff_7 = df[['bus,'rail']].diff(7)['2019-03' : '2019-05']

fig, axs = plt.subplots(2,1,sharex = True, figsize = (8,5))
df.plot(ax=axs[0], legend = False, marker = '.') #ì›ë³¸ ì‹œê³„ì—´
df.shift(7).plot(ax=axs[0], grid = True, legend = False, linestyle = ':') # ì§€ì—°ëœ ì‹œê³„ì—´
diff_7.plot(ax=axs[1], grid = True, marker = '.') # 7ì¼ ê°„ì˜ ì°¨ì´
plt.show()
```

ìê¸°ìƒê´€ : ì‹œê³„ì—´ì´ ì‹œê°„ì´ ì§€ì—°ëœ ìê¸°ìì‹ ê³¼ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§€ëŠ” ê²ƒ

MAEì™€ MAPEë¥¼ ì‚¬ìš©í•œ ì˜ˆì¸¡ ì˜¤ë¥˜ í‰ê°€
```python
# MAE 
diff_7.abs().mean()
```
MAE (í‰ê·  ì ˆëŒ€ ì˜¤ì°¨) : ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ì˜ ì°¨ì´ë¥¼ í‰ê· ë‚¸ ê°’ (ë‹¨ìœ„ê°€ ë°ì´í„°ì™€ ë™ì¼)

MAEê°€ í¬ë‹¤ëŠ” ê²ƒì€ ì˜¤ì°¨ê°€ í¬ë‹¤ëŠ” ì˜ë¯¸!

```python
targets = df[['bus','rail']]['2019-03':'2019-05']
(diff_7/targets).abs().mean()
```
MAPE (í‰ê·  ì ˆëŒ€ ë¹„ìœ¨ ì˜¤ì°¨) : ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ì˜ ì°¨ì´ë¥¼ ì‹¤ì œê°’ìœ¼ë¡œ ë‚˜ëˆˆ ë¹„ìœ¨ í‰ê·  (ë¹„ìœ¨ë¡œ ë‚˜íƒ€ë‚´ë¯€ë¡œ ë‹¨ìœ„ì— ì˜í–¥ X)

ì—°ê°„ ê³„ì ˆì„±ì´ ë‚˜íƒ€ë‚˜ëŠ”ì§€ì— ëŒ€í•´ì„œ ê·¸ë˜í”„ë¥¼ ìƒì„±í•˜ê³  ë¶„ì„í•´ë³´ì.

```python
period = slice('2001','2019')
df_monthly = df.resample('M').mean() #ì›” í‰ê·  ê³„ì‚°
rolling_average_12_months = df_monthly[period].rolling(window=12).mean()

fig, ax = plt.subplots(figsize = (8,4))
df_monthly[period].plot(ax=ax, marker='.')
rolling_average_12_months.plot(ax=ax, grid = True, legend = False)
plt.show()
```
ê·¸ë¦¬ê³  ì°¨ë¶„ì„ ì‚´í´ë³´ì.
```python
df_monthly.diff(12)[period].plot(grid=True, marker = '/', figsize(8,3))
plt.show()
```
![image](https://github.com/user-attachments/assets/ec8b561b-129e-43e5-b26d-9bedf46490f1)

![image](https://github.com/user-attachments/assets/6b7b99be-db80-457d-84af-75e4fc7f39e8)

ì°¨ë¶„ : ì‹œê³„ì—´ ë°ì´í„°ì—ì„œ íŠ¸ë Œë“œì™€ ê³„ì ˆì„±ì„ ì œê±°í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê¸°ë²• (ê°ê°ì˜ ì‹œì ì—ì„œ ì´ì „ ì‹œì ê³¼ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ ì‹œê³„ì—´ ìƒì„±) â†’ ì‹œê°„ì´ ì§€ë‚˜ë„ í‰ê· ê³¼ ë¶„ì‚°ì´ ì¼ì •í•œ **ì •ìƒ ì‹œê³„ì—´** ìƒì„± ê°€ëŠ¥ (ë³€ë™ í­ ì¼ì •í•œ íŒ¨í„´ìœ¼ë¡œ ë³€í™”)

ì˜ˆì¸¡ì—ì„œ ì°¨ë¶„ì´ ì™œ ì¤‘ìš”í•œê°€? 

íŠ¸ë Œë“œë¥¼ ê³ ë ¤í•˜ì—¬ ë§¤ë…„ í‰ê· ì ìœ¼ë¡œ ê°ì†Œí•˜ëŠ” ê°’ (ì±…ì˜ ìŠ¹ê° ì´ìš© ë°ì´í„° ì˜ˆì‹œ)ì„ ë°˜ì˜í•˜ë©´ ì˜ˆì¸¡ ì •í™•ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŒ

â˜† ì°¨ë¶„ì„ ì‚¬ìš©í•˜ë©´ ë‹¨ê¸° íŒ¨í„´ì„ ì‰½ê²Œ í¬ì°©í•  ìˆ˜ ìˆê³ , íŠ¸ë Œë“œë¥¼ ê³ ë ¤í•˜ë©´ ì¥ê¸°ì ì¸ ì˜ˆì¸¡ ì„±ëŠ¥ ê°œì„  ê°€ëŠ¥

### 15.3.1 ARMA ëª¨ë¸

**ARMA (ìê¸° íšŒê·€ ì´ë™ í‰ê· )** = AR (ìê¸° íšŒê·€) + MA (ì´ë™ í‰ê· ) : ì§€ì—°ëœ ê°’ì˜ ê°„ë‹¨í•œ ê°€ì¤‘ì¹˜ í•© ê³„ì‚° + ì´ë™ í‰ê·  í•© â†’ ì˜ˆì¸¡ ìˆ˜ì •

â€» ë§ˆì§€ë§‰ ëª‡ ê°œì˜ ì˜ˆì¸¡ ì˜¤ì°¨ì˜ ê°€ì¤‘ì¹˜ í•© ì‚¬ìš©í•˜ì—¬ ì´ë™ í‰ê·  ê³„ì‚°

***ì´ ëª¨ë¸ì€ ì •ìƒ ì‹œê³„ì—´ì„ ê°€ì •í•œë‹¤!***

ì¦‰, í‰ê· ê³¼ ë¶„ì‚°ì´ ì‹œê°„ì´ ì§€ë‚˜ë„ ì¼ì •í•œ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ê°€ì •í•œë‹¤. but, ì‹¤ì œ ë°ì´í„°ëŠ” ë¹„ì •ìƒ ì‹œê³„ì—´ì´ ëŒ€ë¶€ë¶„.

â†’ ì°¨ë¶„ í™œìš©í•˜ì—¬ ì •ìƒ ì‹œê³„ì—´ë¡œ ë³€í™˜.

ì°¨ë¶„ : ë¯¸ë¶„ì˜ ê·¼ì‚¬ê°’ê³¼ ìœ ì‚¬. ê° íƒ€ì„ ìŠ¤í…ì—ì„œ ì‹œê³„ì—´ì˜ ê¸°ìš¸ê¸° (ì—°ì†ì  ë°ì´í„°ì¼ ë•Œ)

(ì›ë³¸ ì‹œê³„ì—´ì´ dì°¨ ë°©ì •ì‹ í˜•íƒœ íŠ¸ë Œë“œë¥¼ ê°€ì§ˆ ë•Œ : ì—°ì†ì ì¸ dë²ˆì˜ ì°¨ë¶„ì„ ìˆ˜í–‰í•˜ì—¬ ì‹œê³„ì—´ì˜ dì°¨ ë„í•¨ìˆ˜ë¥¼ ê·¼ì‚¬. dì°¨ ë‹¤í•­ì‹ íŠ¸ë Œë“œ ì œê±° ê°€ëŠ¥. ì—¬ê¸°ì„œ dë¥¼ **ëˆ„ì  ì°¨ìˆ˜**ë¼ê³  í•¨)

**ARIMA (ìê¸° íšŒê·€ ëˆ„ì  ì´ë™ í‰ê· )** = AR + I (ì°¨ë¶„) + MA : dë²ˆì˜ ì°¨ë¶„ì„ ìˆ˜í–‰í•˜ì—¬ ì‹œê³„ì—´ì„ ì •ìƒ ìƒíƒœë¡œ ë§Œë“¤ê³ , ì¼ë°˜ì ì¸ ARMA ëª¨ë¸ ì ìš© â†’ ì°¨ë¶„ìœ¼ë¡œ ëºë˜ ê°’ì„ ë‹¤ì‹œ ë”í•¨ (ì›ë˜ ì‹œê³„ì—´ ì˜ˆì¸¡ê°’. ì›ë˜ ìŠ¤ì¼€ì¼ë¡œ ë³µì›)

**SARIMA (ê³„ì ˆì„± ARIMA)** = ì£¼ì–´ì§„ ë¹ˆë„ì— ëŒ€í•œ ê³„ì ˆ í•­ì„ ì¶”ê°€ë¡œ ëª¨ë¸ë§í•˜ëŠ” ARIMAì˜ ìœ í˜• : ì´ 7ê°œì˜ í•˜ì´í¼íŒŒë¼ë¯¸í„°ë¥¼ ê°€ì§

SARIMA ëª¨ë¸ì˜ í•˜ì´í¼íŒŒë¼ë¯¸í„° ì‚´í´ë³´ê¸°

SARIMA ëª¨ë¸ì˜ í•˜ì´í¼íŒŒë¼ë¯¸í„°ëŠ” ARIMA ëª¨ë¸ì„ ìœ„í•œ p,d,q í•˜ì´í¼íŒŒë¼ë¯¸í„°, ê³„ì ˆì„± íŒ¨í„´ì„ ëª¨ë¸ë§ í•˜ê¸° ìœ„í•œ P,D,Q í•˜ì´í¼íŒŒë¼ë¯¸í„°, ê³„ì ˆì„± íŒ¨í„´ì˜ ê°„ê²©ì¸ sê°€ ì¡´ì¬í•œë‹¤. (ê³„ì ˆì„± íŒ¨í„´ì€ ë‹¨ìœ„ë³„ë¡œ ìƒì´í•¨)

|í•˜ì´í¼íŒŒë¼ë¯¸í„°|ì„¤ëª…|
|---|---|
|p|ìê¸°íšŒê·€(AR)ì°¨ìˆ˜|
|d|ì°¨ë¶„ íšŸìˆ˜|
|q|ì´ë™í‰ê· (MA) ì°¨ìˆ˜|
|P|ê³„ì ˆì  ìê¸°íšŒê·€ ì°¨ìˆ˜|
|D|ê³„ì ˆì  ì°¨ë¶„ íšŸìˆ˜|
|Q|ê³„ì ˆì  ì´ë™í‰ê·  ì°¨ìˆ˜|
|m|ê³„ì ˆ ì£¼ê¸°|

ARIMA í´ë˜ìŠ¤ì˜ statsmodels ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í™œìš©í•œ SARIMA ëª¨ë¸ ì ìš©
```python
from statsmodels.tsa.arima.model import ARIMA

origin, today = '2019-01-01', '2019-05-31'
rail_series = df.loc[origin:today]['rail'].asfreq('D') #ì—¬ê¸°ì„œ Dë¥¼ í†µí•´ ë¹ˆë„ë¥¼ ì¼ìë³„ë¡œ ì„¤ì •
model = ARIMA (rail_series, order = (1,0,0), seasonal_order = (0,1,1,7))
model = model.fit()
y_pred = model.forecast ()
# ìœ„ ì½”ë“œëŠ” ì˜ˆì¸¡ë ¥ì´ ì¢‹ì§€ ì•Šë‹¤. ë”°ë¼ì„œ 3,4,5ì›”ì˜ ëª¨ë“  ë‚ ì— ëŒ€í•œ ì˜ˆì¸¡ì„ ë§Œë“¤ê³  ì „ì²´ ê¸°ê°„ì— ëŒ€í•œ MAEë¥¼ ê³„ì‚°í•˜ê² ë‹¤.
origin, start_date, end_date = '2019-01-01', '2019-03-01', '2019-05-31'
time_period = pd.date_range (start_date, end_date)
rail_series = df.loc[origin:end_date]['rail'].asfreq('D')
y_preds = []
for today in time_period.shift(-1) :
  model = ARIMA (rail_series[origin:today], order = (1,0,0), seasonal_order = (0,1,1,7)) # todayê¹Œì§€ ë°ì´í„°ë¡œ í›ˆë ¨
  model = model.fit()
  y_pred = model.forecast()[0]
  y_preds.append(y_pred)

y_preds = pd.Series (y_preds, index = time_period)
mae = (y_preds - rail_series[time_period].abs().mean()
ê²°ê³¼ë¥¼ í‘œì‹œí•˜ì§€ ì•Šì•˜ì§€ë§Œ ì„±ëŠ¥ì´ ë†’ì•„ì¡Œë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```

SARIMA ëª¨ë¸ì˜ í•˜ì´í¼íŒŒë¼ë¯¸í„°ë¥¼ ì„ íƒí•˜ëŠ” ë°©ë²•

ê°€ì¥ ì‰½ê³  ì‹œì‘í•˜ê¸° ì¢‹ì€ ë°©ë²• : ë‹¨ìˆœ ê·¸ë¦¬ë“œ ì„œì¹˜ (ì—¬ëŸ¬ ì¡°í•© ì‹¤í—˜, í•˜ì´í¼íŒŒë¼ë¯¸í„° ê°’ë§Œ ë°”ê¾¸ë©´ì„œ ì½”ë“œ ì‹¤í–‰)

### 15.3.2 ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ìœ„í•œ ë°ì´í„° ì¤€ë¹„í•˜ê¸°
ê°„ë‹¨í•œ ì„ í˜• ëª¨ë¸ë¡œ ì˜ˆì¸¡ì„ ë¨¼ì € ì‹œë„í•´ë³´ê² ë‹¤.

**í›ˆë ¨, ê²€ì¦, í…ŒìŠ¤íŠ¸ ì„¸íŠ¸ ë¶„í•  í›„, í›ˆë ¨ ì„¸íŠ¸ì™€ ê²€ì¦ ì„¸íŠ¸ë¥¼ ìœ„í•œ ë°ì´í„°ì…‹ ìƒì„±**
```python
rail_train = df['rail']['2016-01':'2018-12'] / 1e6 # ê¸°ë³¸ ê°€ì¤‘ì¹˜ ì´ˆê¸°í™”ì™€ í•™ìŠµë¥ ì˜ ì›í™œí•œ ì‘ë™ì„ ìœ„í•œ ë‚˜ëˆ—ì…ˆ
rail_valid = df['rail']['2019-01':'2019-05'] / 1e6
rail_test = df['rail']['2019-06':] / 1e6

seq_length = 56 #ìœˆë„
train_ds = tf.keras.utils.timeseries_dataset_from_array (
  rail_train.to_numpy(),
  targets = rail_train[seq_length:],
  sequence_length = seq_length
  batch_size = 32,
  shuffle = True,
  seed = 42
)
valid_ds = tf.keras.utils.timeseries_dataset_from_array (
  rail_valid.to_numpy(),
  targets = rail_valid[seq_length:],
  sequence_length = seq_length,
  batch_size = 32
)
```
### 15.3.3 ì„ í˜•ëª¨ë¸ë¡œ ì˜ˆì¸¡í•˜ê¸°
**í›„ë²„ ì†ì‹¤ì„ ì´ìš©í•œ ì†ì‹¤ ìµœì†Œí™” ë° ì¡°ê¸° ì¢…ë£Œ ì‚¬ìš©**

â€» REMIND

í›„ë²„ ì†ì‹¤ : MAEì™€ MSEì˜ ì¥ì ì„ ê²°í•©í•œ ì†ì‹¤í•¨ìˆ˜. ì´ìƒì¹˜ì— ê°•ê±´í•˜ì—¬ í° ì˜¤ì°¨ì—ì„œ MAEì²˜ëŸ¼ ì„ í˜•ì ìœ¼ë¡œ ì¦ê°€í•˜ì—¬ ì´ìƒì¹˜ ì˜í–¥ ì¤„ì´ê³ , ì‘ì€ ì˜¤ì°¨ì—ì„œëŠ” MSEì²˜ëŸ¼ ì‘ë™í•˜ì—¬ ë¯¸ë¶„ ê°€ëŠ¥.

```python
tf.random.set_seed(42)
model = tf.keras.Sequential([
  tf.keras.layers.Dense(1,input_shape = [seq_length])
])
early_stopping_cb = tf.keras.callbacks.EarlyStopping(
  monitor = 'val_mae', patience = 50, restore_best_weights = True)
opt = tf.keras.optimizers.SGD(learning_rate = 0.02, momentum = 0.9)
model.compile(loss=tf.keras.losses.Huber(), optimizer = opt, metrics = ['mae'])
history = model.fit (train_ds, validation_data = valid_ds, epochs = 500, callbacks = [early_stopping_cb])
# ê³¼ì í•© ë°©ì§€ ìœ„í•œ ì¡°ê¸°ì¢…ë£Œ
```

### 15.3.4 ê°„ë‹¨í•œ RNNìœ¼ë¡œ ì˜ˆì¸¡í•˜ê¸°
SARIMA í†µê³„ ëª¨ë¸ì´ ì•„ë‹Œ, RNN ë”¥ëŸ¬ë‹ ëª¨ë¸ì„ ì´ìš©í•˜ì—¬ ì˜ˆì¸¡í•´ë³´ì. ì—¬ê¸°ì„œëŠ” ê°€ì¥ ê°„ë‹¨í•œ RNNì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.
```python
univar_model = tf.keras.Sequential([
    tf.keras.layers.SimpleRNN(32, input_shape=[None, 1]),
    tf.keras.layers.Dense(1)  # ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™” í•¨ìˆ˜ê°€ ì—†ìŒ. (íšŒê·€ë¼ì„œ)
])
```
### 15.3.5 ì‹¬ì¸µ RNNìœ¼ë¡œ ì˜ˆì¸¡í•˜ê¸°

![image](https://github.com/user-attachments/assets/41fd5046-3696-4ff0-929b-c756c68c6929)

RNNì€ ì…€ì„ ì—¬ëŸ¬ ì¸µìœ¼ë¡œ ìŒ“ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‹¤. ì´ë¥¼ **ì‹¬ì¸µ RNN**ì´ë¼ê³  í•œë‹¤.

```python
#SimpleRNN 3ê°œë¥¼ ìŒ“ì•„ì„œ ë§Œë“ ë‹¤
deep_model = tf.keras.Sequential ([
  tf.keras.layers.SimpleRNN(32, return_sequences = True, input_shape = [None,1]), #ì‹œí€€ìŠ¤-íˆ¬-ì‹œí€€ìŠ¤
  tf.keras.layers.SimpleRNN(32, return_sequences = True), #ì‹œí€€ìŠ¤-íˆ¬-ì‹œí€€ìŠ¤
  tf.keras.layers.SimpleRNN(32), #ì‹œí€€ìŠ¤-íˆ¬-ë²¡í„°
  tf.keras.layers.Dense(1) #ëª¨ë¸ì˜ ì˜ˆì¸¡ ë§Œë“¦
])
```

### 15.3.6 ë‹¤ë³€ëŸ‰ ì‹œê³„ì—´ ì˜ˆì¸¡í•˜ê¸°
***ë²„ìŠ¤ì™€ ì—´ì°¨ ë°ì´í„°ë¥¼ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©**
```python
#ë²„ìŠ¤ì™€ ì—´ì°¨ ì‹œë¦¬ì¦ˆë¥¼ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©
df_mulvar = df[['vus','rail']] / 1e6
# ë‚´ì¼ì˜ ìš”ì¼ ìœ í˜• ì‚¬ì „ì— ë¯¸ë¦¬ ì•Œê³  ìˆìŒ (ë¯¸ë¦¬ ê²°ì •ëœ ì •ë³´)
df_mulvar = ['next_day_type'] = df['day_type'].shift(-1)
#ì›-í•« ì¸ì½”ë”©
df_mulvar = pd.get_dummies(df_mulvar)

#df_mulvarì€ ë²„ìŠ¤, ì—´ì°¨, ë‚ ì˜ ìš”ì¼ ìœ í˜• W,A,Uì˜ ë‹¤ì„¯ ê°œì˜ ì—´ì„ ê°€ì§„ ë°ì´í„°í”„ë ˆì„ì´ë‹¤.
```

**í›ˆë ¨, ê²€ì¦, í…ŒìŠ¤íŠ¸ ì„¸íŠ¸ ë¶„í• **
```python
mulvar_train = df_mulvar ['2016-01':'2018-12']
mulvar_valid = df_mulvar['2019-01' : '2019-05']
mulvar_test = df_mulvar['2019-06' :]
```
**ë°ì´í„°ì…‹ ìƒì„±**
```python
train_mulvar_ds = tf.keras.utils.timeseries_dataset_from_array(
    mulvar_train.to_numpy(),  # 5ê°œì˜ ì—´ì„ ëª¨ë‘ ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©
    targets=mulvar_train["rail"][seq_length:],  # "rail" ì—´ë§Œ ì˜ˆì¸¡ê°’(íƒ€ê²Ÿ)
    [...]
)

valid_mulvar_ds = tf.keras.utils.timeseries_dataset_from_array(
    mulvar_valid.to_numpy(),
    targets=mulvar_valid["rail"][seq_length:],
    [...]
)
```
**RNN ëª¨ë¸ ìƒì„±**
```python
mulvar_model = tf.keras.Sequential([
    tf.keras.layers.SimpleRNN(32, input_shape=[None, 5]),
    tf.keras.layers.Dense(1)
])
```

ë‹¤ë³€ëŸ‰ ì‹œê³„ì—´ ì˜ˆì¸¡ ëª¨ë¸ ê°œì„  ë° ë‹¤ì¤‘ ì¶œë ¥ RNN íŠ¹ì§•

1. ìƒˆë¡œìš´ RNN ëª¨ë¸ì€ 5ê°œì˜ ì…ë ¥ ë³€ìˆ˜ ì‚¬ìš©í•˜ì—¬ ì˜ˆì¸¡ ìˆ˜í–‰ (ë‹¤ë³€ëŸ‰ ì…ë ¥ì„ í†µí•œ ì„±ëŠ¥ í–¥ìƒ)
2. ê¸°ì¡´ ëª¨ë¸ì€ í•˜ë‚˜ì˜ ì¶œë ¥ ê°’(rail ì˜ˆì¸¡)ë§Œ ìƒì„±í–ˆì§€ë§Œ, ë²„ìŠ¤ì™€ ì—´ì°¨ ìŠ¹ê° ìˆ˜ë¥¼ ëª¨ë‘ ì˜ˆì¸¡í•  ìˆ˜ ìˆë„ë¡ ëª¨ë¸ì„ ë³€ê²½í•  ìˆ˜ ìˆìŒ.
3. ê´€ë ¨ ìˆëŠ” ì—¬ëŸ¬ ì‘ì—…ì„ ë‹¨ì¼ RNN ëª¨ë¸ì—ì„œ í•¨ê»˜ í•™ìŠµí•˜ëŠ” ê²ƒì´ ìœ ë¦¬í•  ìˆ˜ë„ ìˆìŒ

### 15.3.7 ì—¬ëŸ¬ íƒ€ì„ ìŠ¤í… ì• ì˜ˆì¸¡í•˜ê¸°
ì•ì„œ ë‹¤ìŒ íƒ€ì„ ìŠ¤í…ì˜ ê°’ë§Œ ì˜ˆì¸¡í•˜ì˜€ì§€ë§Œ, íƒ€ê¹ƒì„ ì ì ˆíˆ ë°”ê¾¸ì–´ ì—¬ëŸ¬ íƒ€ì„ ìŠ¤í… ì•ì˜ ê°’ì„ ì†ì‰½ê²Œ ì˜ˆì¸¡í•  ìˆ˜ ìˆë‹¤.

ì˜ˆì œ : í˜„ì‹œì ë¶€í„° 2ì£¼ ë’¤ì˜ ìŠ¹ê° ìˆ˜ ì˜ˆì¸¡ ì‹œ 14ì¼ ì•ì˜ ê°’ì„ íƒ€ê¹ƒìœ¼ë¡œ ì‚¬ìš©

ë°©ë²• 1. í•œ ë²ˆì— 1ê°œì˜ ë¯¸ë˜ ê°’ì„ ì˜ˆì¸¡í•œ í›„, ê·¸ ê°’ì„ ë‹¤ì‹œ ì…ë ¥í•˜ì—¬ ë‹¤ìŒ ê°’ì„ ì˜ˆì¸¡í•˜ëŠ” ë°©ì‹
```python
import numpy as np
X = rail_valid.to_numpy()[np.newaxis, :seq_length, np.newaxis]
for step_ahead in range(14):
    y_pred_one = univar_model.predict(X)  # ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ 1ì¼ ë’¤ ê°’ ì˜ˆì¸¡
    X = np.concatenate([X, y_pred_one.reshape(1, 1, 1)], axis=1)  # ì˜ˆì¸¡ê°’ì„ ì…ë ¥ ë°ì´í„°ì— ì¶”ê°€
```
ë°©ë²• 2. í•œ ë²ˆì— ë‹¤ìŒ 14ê°œ ê°’ ì˜ˆì¸¡í•˜ëŠ” RNN í›ˆë ¨ (S2V ë‹¤ì¤‘ ì¶œë ¥)
```python
def split_inputs_and_targets(mulvar_series, ahead=14, target_col=1):
    return mulvar_series[:, :-ahead], mulvar_series[:, -ahead:, target_col]
    #ahead=14: 14ì¼ ì•ê¹Œì§€ ì˜ˆì¸¡í•´ì•¼ í•˜ë¯€ë¡œ íƒ€ê¹ƒì„ 14ì¼ ì´ë™

ahead_train_ds = tf.keras.utils.timeseries_dataset_from_array(
    mulvar_train.to_numpy(),
    targets=None,
    sequence_length=seq_length + 14
    # sequence_length=seq_length + 14 : ì…ë ¥ ì‹œí€€ìŠ¤ë¥¼ ë§Œë“¤ ë•Œ 14ì¼ì„ ì¶”ê°€ë¡œ ê³ ë ¤í•˜ì—¬ ì¶œë ¥(íƒ€ê¹ƒ) ë°ì´í„°ê¹Œì§€ í¬í•¨í•˜ë„ë¡ ì„¤ì •.
).map(split_inputs_and_targets)

ahead_valid_ds = tf.keras.utils.timeseries_dataset_from_array(
    mulvar_valid.to_numpy(),
    targets=None,
    sequence_length=seq_length + 14,
    batch_size=32
).map(split_inputs_and_targets)
# RNN ëª¨ë¸ ìƒ
ahead_model = tf.keras.Sequential([
    tf.keras.layers.SimpleRNN(32, input_shape=[None, 5]),
    tf.keras.layers.Dense(14) #Dense(14): ì¶œë ¥ì¸µì—ì„œ 14ê°œì˜ ê°’ ì˜ˆì¸¡ (14ì¼ ì•ê¹Œì§€ ì˜ˆì¸¡).
])
```

### 15.3.8 ì‹œí€€ìŠ¤-íˆ¬-ì‹œí€€ìŠ¤ ëª¨ë¸ë¡œ ì˜ˆì¸¡í•˜ê¸°





