---
layout : post
title : 심화발제
---
# 1주차 심화발제 - Simpson의 역설

## 전체 개요
```
[인과추론]
   ↑
   │ (원하는 것: A → B 효과가 있나?)
   │
[A/B 테스트] ─▶ [귀무가설 검정]
   │                ↑
   │                │
   │        통계적으로 유의미한 차이가 있는가?
   │
   └─▶ [Simpson의 역설] (주의: 집계 방식에 따라 결론이 달라질 수 있음)
```

## A/B 테스트의 정의와 구조
A/B 테스트의 정의 : 두 가지 처리 방법, 제품, 절차 중 어느 쪽이 다른 쪽 보다 더 우월하다는 것을 입증하기 위해 실험군을 두 그룹으로 나누어 진행하는 실험

**직관적으로**
```
- 우리는 어떤 조치가 효과가 있는지 알고 싶음
- 예: 새로운 광고 전략이 기존보다 더 나은 효과를 보일까?
  -▶ 이러한 이유로 A/B 테스트를 설계
```

A/B 테스트의 구조
```
전체 사용자 집단 (N명)
       │
       └─ 무작위 할당(Random Assignment)
           │
     ┌─────┴─────┐
     │           │
 [A 집단]     [B 집단]
(대조군, 기존 방식)  (처리군, 새로운 방식)
     │           │
     └─────┬─────┘
           ↓
     결과 비교 (Outcome 비교)
       └─> 통계적 검정 (t-test, 순열검정 등)
               └─> 귀무가설 검정 → p-value
```

1. 대상 집단 선정

실험에 참여할 사용자 또는 샘플 모집단을 정의 (예: 웹사이트 방문자, 광고 타겟 등)

2. 무작위 할당 (Random Assignment)

대상자들을 무작위로 A군과 B군에 나눔

이로써 **모든 외생 변수(교란변수)** 가 통계적으로 균등하게 분포할 가능성이 높아짐

3. 처리 적용

A 집단: 기존 방식 또는 아무 처리도 하지 않음 (대조군)

B 집단: 새로운 UI/정책/광고 등 실험 처리 적용 (처리군)

4. 결과 수집 (Outcome)

예: 클릭률, 구매율, 체류 시간, 이탈률 등 실험 목적에 맞는 지표 수집

5. 통계적 분석

귀무가설(H₀): A와 B의 차이는 없다. (즉, 처리 효과 없음)

대립가설(H₁): A와 B는 차이가 있다. (즉, 처리 효과 있음)

→ t-test, chi-square test, 순열검정 등으로 p-value를 산출하여 통계적으로 유의미한 차이를 검정

## A/B 테스트의 한계 : 심슨의 역설
- 귀무가설 검정을 통과한 A/B 테스트 결과도 **잘못된 인과 해석**일 수 있음

- 대표적인 사례: **심슨의 역설 (Simpson's Paradox)**

심슨의 역설 : 부분 집단별로는 같은 방향의 경향이 나타나는데, 전체 데이터를 합쳐버리면 정반대의 결론이 나오는 현상

<img width="500" height="973" alt="image" src="https://github.com/user-attachments/assets/3a9cda18-c9e8-4e48-8a2c-c7fd1226f199" />

현상: 하위 그룹에서는 B가 더 나은데, 전체 데이터로 보면 A가 더 나은 것처럼 나옴

원인: **교란변수(confounder)** 의 분포가 그룹마다 다름

문제: 아무리 귀무가설 검정을 정교하게 하더라도, 집계 단위가 잘못되면 인과추론이 왜곡됨

**교란변수란 무엇인가?**

: 독립변수(X)와 종속변수(Y) 모두에 영향을 주어서, X와 Y 사이에 마치 인과관계가 있는 것처럼 보이게 만드는 제3의 변수를 말함

```
예시:

전체 클릭률: A = 7.2%, B = 6.8% → p < 0.05 → A가 낫다?

그러나 디바이스별로 보면:
모바일: B > A
데스크탑: B > A
→ 교란변수(기기 종류)를 고려하지 않으면 잘못된 인과 해석 유발
```

| A/B 테스트의 전제        | 심슨의 역설이 끼어드는 방식                        |
| ------------------ | -------------------------------------- |
| 무작위 할당 → 교란변수 통제됨  | 통제가 **완벽하지 않거나**, **후처리로 집계**할 때 발생    |
| 전체 평균 차이로 판단       | 세부 집단별 차이와 **정반대 방향의 결과** 가능           |
| 하나의 p-value로 효과 판단 | 집단별 분석 필요 → **다수의 p-value**, 다층적 해석 필요 |

즉, CI나 p-value만 맹신하면 안 되고, 교란변수를 고려해야 한다는 교훈을 얻는다.

**교란변수를 파악하는 방법**

(1) 도메인지식 기반 식별

- 전문가의 지식, 이전 연구, 논리적 사고를 통해 어떤 변수가 X와 Y 둘 다에 영향을 줄 수 있는지를 가정
- ex) : 흡연이 폐암에 영향을 준다고 할 때, 나이는 흡연과 폐암 모두에 영향을 주는 변수 -▶ 교란변수로 가정

(2) 통계적 탐색 (상관관계 기반)
- X,Y 변수 각각에 대해 관련 있는 변수를 찾고 상관분석, 다중공선성 (VIF), 분산분석 등으로 후보 교란변수 찾기
- 단점 : 상관관계만으로는 인과관계를 판단할 수 없으므로, 보조적 도구로 사용한다.

(3) DAG 작성
- X,Y,교란변수 사이의 인과관계를 시각적으로 모델링하여 C가 X->Y 인과 경로 외부에서 영향을 주는지를 파악
- 조건부 독립성을 이용해 어떤 변수를 통제해야 인과성을 볼 수 있는지 판단

## 심슨의 역설 해결 : 교란변수를 처리한 인과추론
단순한 상관관계/평균 차이로는 인과를 말할 수 없다. 

그래서 필요한 것이 정확한 인과추론 (Casual Inference) : 교란변수를 통제하고 인위적/통계적 방법으로 '정말 X가 Y에 영향을 준 것이 맞는가?'를 확인하는 학문 (오염된 추정이 아닌, 더 순수한 인괒거 효과 추정 가능케 하는 것)


**교란변수를 파악하는 방법**

(1) 도메인지식 기반 식별
- 전문가의 지식, 이전 연구, 논리적 사고를 통해 어떤 변수가 X와 Y 둘 다에 영향을 줄 수 있는지를 가정
- ex) : 흡연이 폐암에 영향을 준다고 할 때, 나이는 흡연과 폐암 모두에 영향을 주는 변수 -▶ 교란변수로 가정

(2) 통계적 탐색 (상관관계 기반)
- X,Y 변수 각각에 대해 관련 있는 변수를 찾고 상관분석, 다중공선성 (VIF), 분산분석 등으로 후보 교란변수 찾기
- 단점 : 상관관계만으로는 인과관계를 판단할 수 없으므로, 보조적 도구로 사용한다.
<img width="855" height="802" alt="image" src="https://github.com/user-attachments/assets/213775ef-4dc5-46fb-bf29-73c8cd8928fb" />

(3) DAG 작성을 통한 조건부 독립성 파악 (흥미로워서 DAG에 대해 심층적으로 파봤음)
- X,Y,교란변수 사이의 인과관계를 시각적으로 모델링하여 C가 X->Y 인과 경로 외부에서 영향을 주는지를 파악
- 조건부 독립성을 이용해 어떤 변수를 통제해야 인과성을 볼 수 있는지 판단
<img width="1090" height="492" alt="image" src="https://github.com/user-attachments/assets/677caea6-26b1-4eaf-bb92-d6c1c82a448b" />

- 교란변수와 매개변수는 통제하면 오히려 X->Y 간의 잘못된 연관성을 제거할 수 있음
- 하지만 충돌자 (Colliders)는 통제 불가 : 통제하면 원래 독립이었던 변수들이 인위적으로 연결되어 잘못된 상관관계를 유발할 수 있음

1. Mediator (Chain 구조)
```
X → M → Y
M은 X가 Y에 미치는 과정 중간의 '매개' 변수
```
X와 Y는 M을 조건으로 하면 d-separated (독립됨)

즉, M을 통제하면 X와 Y 간의 직접적인 효과만 추정 가능

```
X: 공부시간, M: 중간고사 점수, Y: 기말고사 점수

중간고사 점수를 통제하면, 공부시간이 기말고사에 미친 직접적인 영향만 남음
```

2. Confounder (Fork 구조)
```
C ← X
C → Y
C는 X와 Y에 공통으로 영향을 주는 외부 요인 (교란변수)
```
C를 통제하지 않으면 X와 Y가 인과가 없어도 상관관계가 생김 (spurious correlation)

C를 통제하면 X와 Y는 d-separated → 순수한 인과 효과 추정 가능
```
X: 아이스크림 판매량, Y: 익사사고 수, C: 날씨

날씨를 통제하지 않으면 X와 Y는 상관 있어 보임

날씨를 통제하면 인과관계가 사라짐 → 진짜 관계는 없음
```
3. Colider (V자, Immorality 구조)
```
X → Z ← Y
Z는 X와 Y가 모두 영향을 주는 결과변수 (공통 결과)
```
Z를 통제하지 않으면 X와 Y는 d-separated → 독립

그런데 Z를 통제하면 X와 Y 사이에 가짜 상관관계가 생김 → 오히려 연결됨 (d-connected)
```
X: 부유함, Y: 근면함, Z: 하버드 입학

하버드에 합격하려면 보통 부유하거나 근면하거나 둘 중 하나의 요인이 강해야 한다고 치자. X와 Y는 상관이 없다.
그런데 하버드 입학(Z)을 통제 (이미 합격했다고 조건화)하면, X와 Y 사이에 (조건부 종속)역상관관계가 생김 (Simpson’s paradox 등)

| X (부유함) | Y (근면함) | Z (합격여부) |
| ------- | ------- | -------- |
| 높음      | 낮음      | 합격       |
| 낮음      | 높음      | 합격       |
| 높음      | 높음      | 합격       |
| 낮음      | 낮음      | 불합격      |

→ “부자인데도 붙었으면, 아마 덜 근면할 것”이라는 잘못된 추론 가능
```


**교란변수 처리(보정) 방법** : 층화, 회귀분석, etc
1. 층화 (Stratification)
- 전체 데이터를 **교란변수의 수준**에 따라 여러 하위 그룹으로 나눈 뒤, 각 그룹 내에서 인과관계를 별도로 분석하는 방법
- 이후 가중 평균을 계산해 전체 효과 집계 가능
- 교란변수가 많아지면 조합 수가 폭발하는 차원의 저주 문제가 생길 수 있음!
2. 회귀분석 (Regression)
- 교란변수를 수식 내 공변량으로 포함하여 그 영향력을 제거하고 X의 효과가 Y에 미치는 인과적 효과만 추출하는 방법
- 교란변수를 통계적으로 제거한 순수한 인과 효과를 추정할 수 있고, 해석이 직관적이고 효율적
- 비선형성을 나타내는 변수들은 인과추론 관점에서 해석 가능성과 교란 통제의 명시성이 부족해 제약이 따름 (보통은 선형성을 가정한다고 함)

## 심슨의 역설과 XAI
확장 논점 : 모델이 도출한 결론은 인과적인가?

1. 왜 XAI에서도 Simpson's Paradox가 중요한가?

**모델 설명이 전체 데이터에서 유효하지만, 하위 그룹에선 정반대일 수 있음**

예: SHAP 값에서 Feature A가 평균적으로 Positive impact를 주지만, 실제로는 특정 조건(C)이 있을 때만 그러한 경우

▶ 여기서 C는 교란변수일 수 있음

**SHAP/Partial Dependence Plot 등의 설명 방식도 Aggregated Explanation(집단/조건을 무시한 채 통합해서 본 설명 = 집계 기반 설명)임**

→ Simpson의 역설과 유사한 집계 오류 가능

▶ "설명 가능한 인공지능"이 "잘못된 인과적 인사이트"를 줄 위험 존재



